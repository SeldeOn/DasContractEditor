{"version":3,"sources":["../../../src/features/context-pad/ContextPadProvider.js"],"names":["assign","isArray","is","isAny","hasPrimaryModifier","ContextPadProvider","eventBus","contextPad","modeling","elementFactory","connect","create","rules","popupMenu","canvas","translate","config","injector","registerProvider","_contextPad","_modeling","_elementFactory","_connect","_create","_rules","_popupMenu","_canvas","_translate","autoPlace","_autoPlace","get","on","event","shape","context","entries","getEntries","replace","action","click","$inject","prototype","getContextPadEntries","element","actions","type","businessObject","startConnect","autoActivate","start","removeElement","e","removeElements","getReplaceMenuPosition","Y_OFFSET","diagramContainer","getContainer","pad","getPad","html","diagramRect","getBoundingClientRect","padRect","top","left","pos","x","y","height","appendAction","className","title","options","appendStart","createShape","source","hints","connectionTarget","append","group","dragstart","isEmpty","position","cursor","open","deleteAllowed","allowed","elements"],"mappings":"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","sourcesContent":["import {\n  assign,\n  isArray\n} from 'min-dash';\n\nimport {\n  is,\n  isAny\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  hasPrimaryModifier\n} from 'diagram-js/lib/util/Mouse';\n\n\n/**\n* A provider for DMN elements context pad\n*/\nexport default function ContextPadProvider(\n    eventBus, contextPad, modeling,\n    elementFactory, connect, create,\n    rules, popupMenu, canvas,\n    translate, config, injector) {\n\n  config = config || {};\n\n  contextPad.registerProvider(this);\n\n  this._contextPad = contextPad;\n\n  this._modeling = modeling;\n\n  this._elementFactory = elementFactory;\n  this._connect = connect;\n  this._create = create;\n  this._rules = rules;\n  this._popupMenu = popupMenu;\n  this._canvas = canvas;\n  this._translate = translate;\n\n  if (config.autoPlace !== false) {\n    this._autoPlace = injector.get('autoPlace', false);\n  }\n\n\n  eventBus.on('create.end', 250, function(event) {\n    var shape = event.context.shape;\n\n    if (!hasPrimaryModifier(event)) {\n      return;\n    }\n\n    var entries = contextPad.getEntries(shape);\n\n    if (entries.replace) {\n      entries.replace.action.click(event, shape);\n    }\n  });\n}\n\nContextPadProvider.$inject = [\n  'eventBus',\n  'contextPad',\n  'modeling',\n  'elementFactory',\n  'connect',\n  'create',\n  'rules',\n  'popupMenu',\n  'canvas',\n  'translate',\n  'config.contextPad',\n  'injector'\n];\n\n\nContextPadProvider.prototype.getContextPadEntries = function(element) {\n\n  var modeling = this._modeling,\n\n      elementFactory = this._elementFactory,\n      connect = this._connect,\n      create = this._create,\n      popupMenu = this._popupMenu,\n      canvas = this._canvas,\n      contextPad = this._contextPad,\n      rules = this._rules,\n      translate = this._translate,\n      autoPlace = this._autoPlace;\n\n  var actions = {};\n\n  if (element.type === 'label') {\n    return actions;\n  }\n\n  var businessObject = element.businessObject;\n\n  function startConnect(event, element, autoActivate) {\n    connect.start(event, element, autoActivate);\n  }\n\n  function removeElement(e) {\n    modeling.removeElements([ element ]);\n  }\n\n  function getReplaceMenuPosition(element) {\n\n    var Y_OFFSET = 5;\n\n    var diagramContainer = canvas.getContainer(),\n        pad = contextPad.getPad(element).html;\n\n    var diagramRect = diagramContainer.getBoundingClientRect(),\n        padRect = pad.getBoundingClientRect();\n\n    var top = padRect.top - diagramRect.top;\n    var left = padRect.left - diagramRect.left;\n\n    var pos = {\n      x: left,\n      y: top + padRect.height + Y_OFFSET\n    };\n\n    return pos;\n  }\n\n  /**\n  * Create an append action\n  *\n  * @param {string} type\n  * @param {string} className\n  * @param {string} [title]\n  * @param {Object} [options]\n  *\n  * @return {Object} descriptor\n  */\n  function appendAction(type, className, title, options) {\n\n    if (typeof title !== 'string') {\n      options = title;\n      title = translate('Append {type}', { type: type.replace(/^dmn:/, '') });\n    }\n\n    function appendStart(event, element) {\n\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      create.start(event, shape, {\n        source: element,\n        hints: {\n          connectionTarget: element\n        }\n      });\n    }\n\n    var append = autoPlace ? function(event, element) {\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      autoPlace.append(element, shape, {\n        connectionTarget: element\n      });\n    } : appendStart;\n\n    return {\n      group: 'model',\n      className: className,\n      title: title,\n      action: {\n        dragstart: appendStart,\n        click: append\n      }\n    };\n  }\n\n  if (is(businessObject, 'dmn:Decision')) {\n    assign(actions, {\n      'append.decision': appendAction('dmn:Decision', 'dmn-icon-decision')\n    });\n  }\n\n  if (\n    isAny(businessObject, [\n      'dmn:BusinessKnowledgeModel',\n      'dmn:Decision',\n      'dmn:KnowledgeSource'\n    ])\n  ) {\n    assign(actions, {\n      'append.knowledge-source': appendAction(\n        'dmn:KnowledgeSource',\n        'dmn-icon-knowledge-source'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [\n    'dmn:BusinessKnowledgeModel',\n    'dmn:Decision'\n  ])) {\n    assign(actions, {\n      'append.business-knowledge-model': appendAction(\n        'dmn:BusinessKnowledgeModel',\n        'dmn-icon-business-knowledge'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [ 'dmn:Decision', 'dmn:KnowledgeSource' ])) {\n    assign(actions, {\n      'append.input-data': appendAction('dmn:InputData', 'dmn-icon-input-data')\n    });\n  }\n\n  if (is(businessObject, 'dmn:DRGElement')) {\n\n    assign(actions, {\n      'append.text-annotation': appendAction(\n        'dmn:TextAnnotation',\n        'dmn-icon-text-annotation'\n      ),\n\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect using Information/Knowledge' +\n          '/Authority Requirement or Association'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (is(businessObject, 'dmn:TextAnnotation')) {\n    assign(actions, {\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect using association'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (!popupMenu.isEmpty(element, 'dmn-replace')) {\n\n    // Replace menu entry\n    assign(actions, {\n      'replace': {\n        group: 'edit',\n        className: 'dmn-icon-screw-wrench',\n        title: translate('Change type'),\n        action: {\n          click: function(event, element) {\n\n            var position = assign(getReplaceMenuPosition(element), {\n              cursor: { x: event.x, y: event.y }\n            });\n\n            popupMenu.open(element, 'dmn-replace', position);\n          }\n        }\n      }\n    });\n  }\n\n\n  // delete element entry, only show if allowed by rules\n  var deleteAllowed = rules.allowed('elements.delete', { elements: [ element ] });\n\n  if (isArray(deleteAllowed)) {\n\n    // was the element returned as a deletion candidate?\n    deleteAllowed = deleteAllowed[0] === element;\n  }\n\n  if (deleteAllowed) {\n    assign(actions, {\n      'delete': {\n        group: 'edit',\n        className: 'dmn-icon-trash',\n        title: translate('Remove'),\n        action: {\n          click: removeElement\n        }\n      }\n    });\n  }\n\n  return actions;\n};\n"],"file":"ContextPadProvider.js"}