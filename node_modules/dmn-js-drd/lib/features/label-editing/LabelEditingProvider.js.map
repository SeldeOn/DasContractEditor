{"version":3,"sources":["../../../src/features/label-editing/LabelEditingProvider.js"],"names":["getLabel","is","assign","isDefined","LabelEditingProvider","canvas","directEditing","eventBus","modeling","textRenderer","_canvas","_modeling","_textRenderer","registerProvider","on","event","activate","element","complete","cancel","e","shape","$inject","prototype","text","context","editingBBox","getEditingBBox","options","centerVertically","resizable","target","label","bbox","getAbsoluteBBox","bounds","x","y","zoom","defaultStyle","getDefaultStyle","defaultFontSize","fontSize","defaultLineHeight","lineHeight","style","fontFamily","fontWeight","width","height","paddingTop","paddingBottom","paddingLeft","paddingRight","minWidth","minHeight","textAlign","update","newLabel","activeContextText","newBounds","isEmptyText","updateLabel","trim"],"mappings":"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","sourcesContent":["import { getLabel } from './LabelUtil';\n\nimport {\n  is\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  assign,\n  isDefined\n} from 'min-dash';\n\n\nexport default function LabelEditingProvider(\n    canvas,\n    directEditing,\n    eventBus,\n    modeling,\n    textRenderer\n) {\n\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n\n  directEditing.registerProvider(this);\n\n  // listen to dblclick on non-root elements\n  eventBus.on('element.dblclick', function(event) {\n    directEditing.activate(event.element);\n  });\n\n  // complete on followup canvas operation\n  eventBus.on([\n    'autoPlace.start',\n    'canvas.viewbox.changing',\n    'drag.init',\n    'drillDown.click',\n    'element.mousedown',\n    'popupMenu.open'\n  ], function() {\n    directEditing.complete();\n  });\n\n  // cancel on command stack changes\n  eventBus.on([ 'commandStack.changed' ], function() {\n    directEditing.cancel();\n  });\n\n  eventBus.on('create.end', 500, function(e) {\n\n    var element = e.shape;\n\n    if (\n      is(element, 'dmn:Decision') ||\n      is(element, 'dmn:InputData') ||\n      is(element, 'dmn:BusinessKnowledgeModel') ||\n      is(element, 'dmn:KnowledgeSource') ||\n      is(element, 'dmn:TextAnnotation')\n    ) {\n      directEditing.activate(element);\n    }\n  });\n\n  eventBus.on('autoPlace.end', 500, function(event) {\n    directEditing.activate(event.shape);\n  });\n}\n\nLabelEditingProvider.$inject = [\n  'canvas',\n  'directEditing',\n  'eventBus',\n  'modeling',\n  'textRenderer'\n];\n\n\n/**\n * Activate direct editing for drgs and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size) and text\n */\nLabelEditingProvider.prototype.activate = function(element) {\n\n  var text = getLabel(element);\n\n  if (!isDefined(text)) {\n    return;\n  }\n\n  var context = {\n    text: text\n  };\n\n  var editingBBox = this.getEditingBBox(element);\n\n  assign(context, editingBBox);\n\n  var options = {};\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(options, {\n      centerVertically: true\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true\n    });\n  }\n\n  assign(context, {\n    options: options\n  });\n\n  return context;\n};\n\n\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object}\n *         an object containing information about position and\n *         size (fixed or minimum and/or maximum)\n */\nLabelEditingProvider.prototype.getEditingBBox = function(element) {\n  var canvas = this._canvas;\n\n  var target = element.label || element;\n\n  var bbox = canvas.getAbsoluteBBox(target);\n\n  // default position\n  var bounds = { x: bbox.x, y: bbox.y };\n\n  var zoom = canvas.zoom();\n\n  var defaultStyle = this._textRenderer.getDefaultStyle();\n\n  // take zoom into account\n  var defaultFontSize = defaultStyle.fontSize * zoom,\n      defaultLineHeight = defaultStyle.lineHeight;\n\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  };\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px'\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: (5 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (7 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n\n  return { bounds: bounds, style: style };\n};\n\n\nLabelEditingProvider.prototype.update = function(\n    element,\n    newLabel,\n    activeContextText,\n    bounds\n) {\n  var newBounds,\n      bbox;\n\n  if (is(element, 'dmn:TextAnnotation')) {\n\n    bbox = this._canvas.getAbsoluteBBox(element);\n\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n\n  this._modeling.updateLabel(element, newLabel, newBounds);\n};\n\n// helpers //////////\n\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}"],"file":"LabelEditingProvider.js"}