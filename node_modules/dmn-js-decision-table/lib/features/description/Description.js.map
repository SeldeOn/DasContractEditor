{"version":3,"sources":["../../../src/features/description/Description.js"],"names":["isString","isAny","getNodeById","DescriptionEditor","LOW_PRIORITY","LOWER_PRIORITY","OFFSET_X","Description","components","contextMenu","elementRegistry","eventBus","modeling","renderer","translate","cell","_modeling","updateProperties","description","container","_renderer","getContainer","node","id","bounds","getBoundingClientRect","position","getPosition","_contextMenu","open","contextMenuType","autoFocus","offset","x","y","close","_translate","on","event","defaultPrevented","target","element","get","getDescription","preventDefault","onGetComponent","context","businessObject","existingDescription","className","onClick","removeDescription","addDescription","$inject","top","left","width","height","parentNode","scrollLeft","scrollTop"],"mappings":"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","sourcesContent":["import { isString } from 'min-dash';\r\n\r\nimport { isAny } from 'dmn-js-shared/lib/util/ModelUtil';\r\n\r\nimport {\r\n  getNodeById\r\n} from '../cell-selection/CellSelectionUtil';\r\n\r\nimport DescriptionEditor from './components/DescriptionEditor';\r\n\r\nconst LOW_PRIORITY = 500;\r\n\r\nconst LOWER_PRIORITY = 750;\r\n\r\nconst OFFSET_X = 26;\r\n\r\n\r\nexport default class Description {\r\n\r\n  constructor(\r\n      components, contextMenu, elementRegistry,\r\n      eventBus, modeling, renderer, translate) {\r\n\r\n    this._contextMenu = contextMenu;\r\n    this._modeling = modeling;\r\n    this._renderer = renderer;\r\n    this._translate = translate;\r\n\r\n\r\n    eventBus.on('cell.click', LOWER_PRIORITY, (event) => {\r\n\r\n      if (event.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      const {\r\n        target,\r\n        id\r\n      } = event;\r\n\r\n      const element = elementRegistry.get(id);\r\n\r\n      if (!isAny(element, [ 'dmn:UnaryTests', 'dmn:LiteralExpression' ])) {\r\n        return;\r\n      }\r\n\r\n      const description = getDescription(element);\r\n\r\n      if (!description) {\r\n\r\n        // prevent focus\r\n        event.preventDefault();\r\n      }\r\n\r\n      const container = renderer.getContainer(),\r\n            bounds = target.getBoundingClientRect();\r\n\r\n      const position = getPosition(container, bounds);\r\n\r\n      contextMenu.open(position, {\r\n        contextMenuType: 'cell-description',\r\n        autoFocus: false,\r\n        id,\r\n        offset: {\r\n          x: 4,\r\n          y: 4\r\n        }\r\n      });\r\n    });\r\n\r\n    components.onGetComponent('context-menu', (context = {}) => {\r\n      if (context.contextMenuType\r\n        && context.contextMenuType === 'cell-description') {\r\n\r\n        const element = elementRegistry.get(context.id);\r\n\r\n        const description = getDescription(element);\r\n\r\n        if (isString(description)) {\r\n          return DescriptionEditor;\r\n        }\r\n      }\r\n    });\r\n\r\n    components.onGetComponent('context-menu-cell-additional', LOW_PRIORITY,\r\n      (context = {}) => {\r\n        if (context.contextMenuType\r\n          && context.contextMenuType === 'context-menu') {\r\n\r\n          const { id } = context;\r\n\r\n          if (!id) {\r\n            return;\r\n          }\r\n\r\n          const element = elementRegistry.get(id);\r\n\r\n          // element might not be in element registry (e.g. cut)\r\n          if (!element) {\r\n            return;\r\n          }\r\n\r\n          const { businessObject } = element;\r\n\r\n          const { description } = businessObject;\r\n\r\n          const existingDescription = isString(description);\r\n\r\n          const className =\r\n            existingDescription\r\n              ? 'remove-description'\r\n              : 'add-description';\r\n\r\n          const onClick =\r\n            existingDescription\r\n              ? () => this.removeDescription(element)\r\n              : () => this.addDescription(element);\r\n\r\n          return (\r\n            <div\r\n              className={ `context-menu-group-entry ${ className }` }\r\n              onClick={ onClick }>\r\n              {\r\n                isString(description)\r\n                  ?\r\n                  this._translate('Remove Cell Description')\r\n                  :\r\n                  this._translate('Add Cell Description')\r\n              }\r\n            </div>\r\n          );\r\n        }\r\n      });\r\n  }\r\n\r\n  addDescription = (cell) => {\r\n    this._modeling.updateProperties(cell, {\r\n      description: ''\r\n    });\r\n\r\n    const container = this._renderer.getContainer();\r\n\r\n    const node = getNodeById(cell.id, container);\r\n\r\n    const bounds = node.getBoundingClientRect();\r\n\r\n    const position = getPosition(container, bounds);\r\n\r\n    this._contextMenu.open(position, {\r\n      contextMenuType: 'cell-description',\r\n      id: cell.id,\r\n      autoFocus: true,\r\n      offset: {\r\n        x: 4,\r\n        y: 4\r\n      }\r\n    });\r\n  }\r\n\r\n  removeDescription = (cell) => {\r\n    this._modeling.updateProperties(cell, {\r\n      description: null\r\n    });\r\n\r\n    this._contextMenu.close();\r\n  }\r\n}\r\n\r\nDescription.$inject = [\r\n  'components',\r\n  'contextMenu',\r\n  'elementRegistry',\r\n  'eventBus',\r\n  'modeling',\r\n  'renderer',\r\n  'translate'\r\n];\r\n\r\n// helpers //////////\r\n\r\nfunction getPosition(container, bounds) {\r\n  const { top, left, width, height } = bounds;\r\n\r\n  return {\r\n    x: left + container.parentNode.scrollLeft - OFFSET_X,\r\n    y: top + container.parentNode.scrollTop,\r\n    width: width + (2 * OFFSET_X),\r\n    height\r\n  };\r\n}\r\n\r\nfunction getDescription(element) {\r\n  return element\r\n    && element.businessObject\r\n    && element.businessObject.description;\r\n}"],"file":"Description.js"}